---
title: "Hands-On Exercise 03"
author: "Henry Low"
date: "Sep 7 2024"
date-modified: "last-modified"
execute:
  evalu: true
  echo: true
  message: false
  freeze: true
format: html
editor: visual
---

# Data Sources

*(saved under 'data' folder)*\
Study Area - Punggol Planning Area Punggol_St - line feature geospatial dataset containing road network Punggol_CC - point feature geospatial dataset containing location of childcare centres

# Chapter 7: Network Constrained Spatial Point Patterns Analysis

## 7.1 Setting Up

### 7.1.1 Loading the R packages

```{r}
pacman::p_load(sf, spNetwork, tmap, tidyverse)
```

### 7.1.2 Importing spatial data

```{r}
# Load network dataset
network <- st_read(dsn="data", layer="Punggol_St")
```

```{r}
# Load childcare dataset
childcare <- st_read(dsn="data", layer="Punggol_CC")
```

```{r}
# Load childcare dataset
childcare <- st_read(dsn="data", layer="Punggol_CC")
```

::: panel-tabset
# Childcare

```{r}
# See childcare features
childcare
```

```{r}
# See childcare crs information
st_crs(childcare)
```

# Network

```{r}
# See network features
network
```

```{r}
# See network crs information
st_crs(network)
```
:::


## 7.2 Visualize Geospatial Data

```{r}
# Visualize both geospatial data
plot(st_geometry(network))
plot(childcare,add=T,col='red',pch = 19)
```
```{r}
# Interactive Visualization with tmap 
tmap_mode('view')
tm_shape(childcare) + 
  tm_dots() + 
  tm_shape(network) +
  tm_lines()
```


```{r}
# Set tmap_mode back to plot
tmap_mode('plot')
```

## 7.3 Network KDE (NKDE) ANalysis

### 7.3.1 Prepare Lixel Objects

```{r}
# Cut spatiallines objects into lixels with specified minimal distance using lixelize_lines from spNetwork
lixels <- lixelize_lines(network, 700, mindist = 375)
```

### 7.3.2 Generate line centre points

```{r}
# create line centre points with lines_center from spNetwork
samples <- lines_center(lixels) 
```


### 7.3.3 Perform NKDE

```{r}
# Remove Z-dimension from childcare
childcare_rmz <- st_zm(childcare)

# Perform NKDE
densities <- nkde(network, 
                  events = childcare_rmz,
                  w = rep(1, nrow(childcare_rmz)),
                  samples = samples,
                  kernel_name = "quartic",
                  bw = 300, 
                  div= "bw", 
                  method = "simple", 
                  digits = 1, 
                  tol = 1,
                  grid_shape = c(1,1), 
                  max_depth = 8,
                  agg = 5, 
                  sparse = TRUE,
                  verbose = FALSE)
```


```{r}
# Insert computed density values as density field
samples$density <- densities
lixels$density <- densities

# Recaling to enhance mapping
samples$density <- samples$density*1000
lixels$density <- lixels$density*1000

# Visualize interactive plot
tmap_mode('view')
tm_shape(lixels)+
  tm_lines(col="density")+
tm_shape(childcare)+
  tm_dots()
tmap_mode('plot')
```

## 7.4 Network Constrainted G- and K- Function Analysis

Ho: The observed spatial point events (i.e distribution of childcare centres) are uniformly distributed over a street network in Punggol Planning Area.

```{r}
# Perform complete spatial randomness test using kfunction from spNetwork
kfun_childcare <- kfunctions(network, 
                             childcare,
                             start = 0, 
                             end = 1000, 
                             step = 50, 
                             width = 50, 
                             nsim = 50, 
                             resolution = 50,
                             verbose = FALSE, 
                             conf_int = 0.05)
```


```{r}
# Visualize k-function output
kfun_childcare$plotk
```



